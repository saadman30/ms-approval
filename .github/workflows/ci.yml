name: Continuous Integration

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/ms-approval

jobs:
  # Job 1: Lint and Code Quality
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better caching

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (if configured)
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            npm run lint || echo "Linting not configured, skipping"
          else
            echo "ESLint not configured, skipping"
          fi
        continue-on-error: true

      - name: TypeScript type checking
        run: |
          npm run build --workspaces --if-present || echo "Build check completed"
        continue-on-error: false

  # Job 2: Unit Tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        service: 
          - identity-service
          - organization-service
          - workflow-service
          - billing-service
          - notification-service
          - audit-service
          - analytics-service
        include:
          - service: packages
            test-path: packages
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests for ${{ matrix.service }}
        run: |
          if [ -f "services/${{ matrix.service }}/package.json" ]; then
            cd services/${{ matrix.service }}
            npm test || echo "Tests not configured for ${{ matrix.service }}"
          elif [ -f "packages/events/package.json" ] || [ -f "packages/observability/package.json" ]; then
            npm test --workspace=packages/events --workspace=packages/observability || echo "Package tests not configured"
          else
            echo "No tests found, skipping"
          fi
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: |
            **/coverage
            **/test-results
          retention-days: 7

  # Job 3: Build all services
  build:
    name: Build Services
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint]
    strategy:
      matrix:
        service:
          - identity-service
          - organization-service
          - workflow-service
          - billing-service
          - notification-service
          - audit-service
          - analytics-service
          - gateway
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" = "gateway" ]; then
            cd gateway
            npm run build || echo "Gateway build not configured"
          else
            cd services/${{ matrix.service }}
            npm run build || echo "Build not configured for ${{ matrix.service }}"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}
          path: |
            services/${{ matrix.service }}/dist
            gateway/dist
          retention-days: 7
          if-no-files-found: ignore

  # Job 4: Dependency Vulnerability Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Run npm audit (production)
        run: npm audit --production --audit-level=moderate || true
        continue-on-error: true

  # Job 5: Check for changed services (for selective builds)
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      packages: ${{ steps.changes.outputs.packages }}
      gateway: ${{ steps.changes.outputs.gateway }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          fi

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          
          SERVICES=""
          PACKAGES=""
          GATEWAY="false"
          
          for file in $CHANGED_FILES; do
            if [[ $file == services/* ]]; then
              SERVICE=$(echo $file | cut -d'/' -f2)
              if [[ ! " $SERVICES " =~ " $SERVICE " ]]; then
                SERVICES="$SERVICES $SERVICE"
              fi
            elif [[ $file == packages/* ]]; then
              PACKAGES="true"
            elif [[ $file == gateway/* ]]; then
              GATEWAY="true"
            fi
          done
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "gateway=$GATEWAY" >> $GITHUB_OUTPUT
          
          echo "Changed services: $SERVICES"
          echo "Changed packages: $PACKAGES"
          echo "Changed gateway: $GATEWAY"
