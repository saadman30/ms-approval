version: '3.8'

services:
  # Kafka / Redpanda
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr
      - internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr
      - internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --smp
      - '1'
      - --memory
      - 1G
      - --mode
      - dev-container
      - --default-log-level=info
    ports:
      - "18081:18081"
      - "18082:18082"
      - "19092:19092"
      - "19644:9644"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # PostgreSQL - Identity Service
  postgres-identity:
    image: postgres:16-alpine
    container_name: postgres-identity
    environment:
      POSTGRES_DB: identity
      POSTGRES_USER: identity_user
      POSTGRES_PASSWORD: identity_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres-identity-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U identity_user -d identity"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - Organization Service
  postgres-organization:
    image: postgres:16-alpine
    container_name: postgres-organization
    environment:
      POSTGRES_DB: organization
      POSTGRES_USER: organization_user
      POSTGRES_PASSWORD: organization_pass
    ports:
      - "5433:5432"
    volumes:
      - postgres-organization-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U organization_user -d organization"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - Workflow Service
  postgres-workflow:
    image: postgres:16-alpine
    container_name: postgres-workflow
    environment:
      POSTGRES_DB: workflow
      POSTGRES_USER: workflow_user
      POSTGRES_PASSWORD: workflow_pass
    ports:
      - "5434:5432"
    volumes:
      - postgres-workflow-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U workflow_user -d workflow"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - Billing Service
  postgres-billing:
    image: postgres:16-alpine
    container_name: postgres-billing
    environment:
      POSTGRES_DB: billing
      POSTGRES_USER: billing_user
      POSTGRES_PASSWORD: billing_pass
    ports:
      - "5435:5432"
    volumes:
      - postgres-billing-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U billing_user -d billing"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - Audit Service
  postgres-audit:
    image: postgres:16-alpine
    container_name: postgres-audit
    environment:
      POSTGRES_DB: audit
      POSTGRES_USER: audit_user
      POSTGRES_PASSWORD: audit_pass
    ports:
      - "5436:5432"
    volumes:
      - postgres-audit-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U audit_user -d audit"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - Analytics Service
  postgres-analytics:
    image: postgres:16-alpine
    container_name: postgres-analytics
    environment:
      POSTGRES_DB: analytics
      POSTGRES_USER: analytics_user
      POSTGRES_PASSWORD: analytics_pass
    ports:
      - "5437:5432"
    volumes:
      - postgres-analytics-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U analytics_user -d analytics"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Notification Service
  redis-notification:
    image: redis:7-alpine
    container_name: redis-notification
    ports:
      - "6379:6379"
    volumes:
      - redis-notification-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Jaeger
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # UI
      - "14268:14268"  # HTTP collector
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:16686/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Loki
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./infrastructure/loki/loki-config.yml:/etc/loki/local-config.yaml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana (for visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway
  api-gateway:
    build: ./gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - IDENTITY_SERVICE_URL=http://host.docker.internal:3001
      - ORGANIZATION_SERVICE_URL=http://host.docker.internal:3002
      - WORKFLOW_SERVICE_URL=http://host.docker.internal:3003
      - BILLING_SERVICE_URL=http://host.docker.internal:3004
      - NOTIFICATION_SERVICE_URL=http://host.docker.internal:3005
      - AUDIT_SERVICE_URL=http://host.docker.internal:3006
      - ANALYTICS_SERVICE_URL=http://host.docker.internal:3007
    depends_on:
      - redpanda
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redpanda-data:
  postgres-identity-data:
  postgres-organization-data:
  postgres-workflow-data:
  postgres-billing-data:
  postgres-audit-data:
  postgres-analytics-data:
  redis-notification-data:
  prometheus-data:
  loki-data:
  grafana-data:
